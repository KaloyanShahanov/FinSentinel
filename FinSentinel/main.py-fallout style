import tkinter as tk
from tkinter import scrolledtext
import logging
import os
import sys

from app.logger import logger
from app.sentinel import start_crypto_monitor, stop_crypto_monitor

# Colors (Fallout 4 style)
BG_COLOR = "#000000"
FG_COLOR = "#00FF00"
BTN_HOVER = "#003300"
FONT = ("Courier New", 11)

# Determine absolute log path
def get_log_path():
    base_dir = getattr(sys, '_MEIPASS', os.path.dirname(os.path.abspath(__file__)))
    return r"C:\Users\GRIGS\source\repos\FinSentinel\FinSentinel\logs\crypto_monitor.log"

log_file_path = get_log_path()
os.makedirs(os.path.dirname(log_file_path), exist_ok=True)

# Main window
root = tk.Tk()
root.overrideredirect(True)  # Remove system title bar
root.geometry("1280x720")
root.configure(bg=BG_COLOR)

# === Custom Title Bar ===
def start_move(event):
    root.x = event.x
    root.y = event.y

def stop_move(event):
    root.x = None
    root.y = None

def on_move(event):
    deltax = event.x - root.x
    deltay = event.y - root.y
    x = root.winfo_x() + deltax
    y = root.winfo_y() + deltay
    root.geometry(f"+{x}+{y}")

def minimize_window():
    root.iconify()

def toggle_maximize():
    if root.attributes("-zoomed"):
        root.attributes("-zoomed", False)
    else:
        root.attributes("-zoomed", True)

def close_window():
    stop_crypto_monitor()
    root.destroy()

title_bar = tk.Frame(root, bg=BG_COLOR, relief='raised', bd=0, height=30)
title_bar.pack(fill=tk.X)
title_bar.bind('<Button-1>', start_move)
title_bar.bind('<B1-Motion>', on_move)

title_label = tk.Label(title_bar, text="FinSentinel Monitor", bg=BG_COLOR, fg=FG_COLOR, font=("Courier New", 14, "bold"))
title_label.pack(side='left', padx=10)

btn_style = {"bg": BG_COLOR, "fg": FG_COLOR, "bd": 0, "font": ("Courier New", 12, "bold"),
             "activebackground": BTN_HOVER, "activeforeground": FG_COLOR, "width": 3}

tk.Button(title_bar, text='–', command=minimize_window, **btn_style).pack(side='right', padx=1)
tk.Button(title_bar, text='□', command=toggle_maximize, **btn_style).pack(side='right', padx=1)
tk.Button(title_bar, text='✕', command=close_window, **btn_style).pack(side='right', padx=1)

# === Status label ===
status_label = tk.Label(root, text="Not monitoring", font=("Courier New", 12), bg=BG_COLOR, fg=FG_COLOR)
status_label.pack(pady=5)

# === Log display ===
frame = tk.Frame(root, bg=BG_COLOR)
frame.pack(fill='both', expand=True, padx=10, pady=10)

log_display = tk.Text(frame, wrap='word', state='normal', font=FONT, bg=BG_COLOR, fg=FG_COLOR,
                      insertbackground=FG_COLOR, relief='flat')
log_display.pack(side='left', fill='both', expand=True)

scrollbar = tk.Scrollbar(frame, command=log_display.yview, bg=BG_COLOR, troughcolor=BG_COLOR,
                         activebackground=BTN_HOVER)
scrollbar.pack(side='right', fill='y')

log_display.config(yscrollcommand=scrollbar.set)

# === GUI log handler ===
class TextHandler(logging.Handler):
    def __init__(self, widget):
        super().__init__()
        self.widget = widget

    def emit(self, record):
        msg = self.format(record)
        self.widget.after(0, self._write, msg)

    def _write(self, msg):
        self.widget.insert(tk.END, msg + '\n')
        self.widget.see(tk.END)

gui_handler = TextHandler(log_display)
gui_handler.setFormatter(logging.Formatter('%(asctime)s - %(levelname)s - %(message)s'))
logger.addHandler(gui_handler)

# === Control functions ===
def start_monitor():
    try:
        start_crypto_monitor()
        status_label.config(text="Monitoring started")
        logger.info("Started crypto monitoring.")
    except Exception:
        status_label.config(text="Error starting monitor")
        logger.exception("Failed to start monitoring")

def stop_monitor():
    try:
        stop_crypto_monitor()
        status_label.config(text="Monitoring stopped")
        logger.info("Stopped crypto monitoring.")
    except Exception:
        status_label.config(text="Error stopping monitor")
        logger.exception("Failed to stop monitoring")

# === Buttons ===
tk.Button(root, text="Start", font=FONT, command=start_monitor,
          bg=BG_COLOR, fg=FG_COLOR, activebackground=BTN_HOVER, activeforeground=FG_COLOR).pack(pady=5)

tk.Button(root, text="Stop", font=FONT, command=stop_monitor,
          bg=BG_COLOR, fg=FG_COLOR, activebackground=BTN_HOVER, activeforeground=FG_COLOR).pack(pady=5)

# Run
root.mainloop()
